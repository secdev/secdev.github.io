<html>

<head>
<title>Scapy</title>
<link rel="stylesheet" href="scapy.css" type="text/css">
</head>


<body>


<h1>Scapy</h1>

Please also have a look at the <a href="http://www.secdev.org/projects/scapy/doc/usage.html#interactive-tutorial">interactive tutorial</a> in the official documentation, that may be more up to date.


<h2>Quick demo : an interactive session</h2>

If you are new to python and you really don't understand a word because of that,
or if you want to learn this language, take an hour to read the very good tutorial
from Guido Van Rossum here: <a href="http://docs.python.org/tutorial/">http://docs.python.org/tutorial/</a>. After that, you'll know python :) (really!). For a more in-depth tutorial <a href="http://diveintopython.org/toc/index.html">Dive Into Python</a> is a very good start too.

<p>

<p>
Scapy uses the python interpreter as a command board. That means that you can use 
directly python language (assign variables, use loops, define functions, etc.)
<p>

The idea is simple. Scapy mainly does two things : sending packets and
receiving answers.  You define a set of packets, 
it sends them, receives answers, matches requests with answers and 
returns a list of packet couples (request, answer) and a list of
unmatched packets. This has the big advantage over tools like nmap or hping
that an answer is not reduced to (open/closed/filtered), but is the 
whole packet.
<P>
On top of this can be build more high level functions, for example one that 
does traceroutes and give as a result only the start TTL of the request 
and the source IP of the answer. One that pings a whole network
and gives the list of machines answering. One that does a portscan and
returns a LaTeX report.
<p>


First, we play a bit and create 4 IP packets at once. Let's see how it works.
We first instantiate the IP class. Then, we instantiate it again and
we provide a destination that is worth 4 IP addresses (/30 gives the netmask).
Using a Python idiom, we develop this implicit packet in a set of explicit 
packets. 

<pre>
# ./scapy.py
Welcome to Scapy (0.9.17.108beta)
<span class=prompt>&gt;&gt;&gt;</span> IP()
<span>&lt;</span><span class=layer_name>IP</span><span> |</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> target="www.target.com"
<span class=prompt>&gt;&gt;&gt;</span> target="www.target.com/30"
<span class=prompt>&gt;&gt;&gt;</span> ip=IP(dst=target)
<span class=prompt>&gt;&gt;&gt;</span> ip
</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>&lt;Net www.target.com/30&gt;</span><span> |</span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> [p for p in ip]
[</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>207.171.175.28</span><span> |</span><span>&gt;, </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>207.171.175.29</span><span> |</span><span>&gt;, 
 </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>207.171.175.30</span><span> |</span><span>&gt;, </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>207.171.175.31</span><span> |</span><span>&gt;]
</pre>

<p>
The configuration is hold into a variable named <tt>conf</tt>, which
is saved in the session.
<pre>
<span class=prompt>&gt;&gt;&gt;</span> conf
Version    = 0.9.17.108beta
BTsocket   = &lt;class __main__.BluetoothSocket at 0xb7d73f2c&gt;
IPCountry_base = 'GeoIPCountry4Scapy.gz'
L2listen   = &lt;class __main__.L2ListenSocket at 0xb7d73e3c&gt;
L2socket   = &lt;class __main__.L2Socket at 0xb7d73e0c&gt;
L3socket   = &lt;class __main__.L3PacketSocket at 0xb7d73ddc&gt;
checkIPID  = 1
checkIPaddr = 1
checkIPsrc = 1
color_theme = &lt;class __main__.HTMLTheme at 0xb7d263ec&gt;
countryLoc_base = 'countryLoc.csv'
debug_dissector = 0
debug_match = 0
except_filter = ''
gnuplot_world = 'world.dat'
histfile   = '/home/pbi/.scapy_history'
iface      = 'eth1'
nmap_base  = '/usr/share/nmap/nmap-os-fingerprints'
p0f_base   = '/etc/p0f.fp'
padding    = 1
promisc    = 1
prompt     = '&gt;&gt;&gt; '
queso_base = '/etc/queso.conf'
route      = 
Network         Netmask         Gateway         Iface           Output IP
127.0.0.0       255.0.0.0       0.0.0.0         lo              127.0.0.1      
192.168.5.0     255.255.255.0   0.0.0.0         eth1            192.168.5.21   
0.0.0.0         0.0.0.0         192.168.5.1     eth1            192.168.5.21   
session    = 'mysession'
session_tracking = {}
sniff_promisc = 1
stealth    = 'not implemented'
verb       = 2
warning_threshold = 5
wepkey     = ''
<span class=prompt>&gt;&gt;&gt;</span> conf.verb=1
<span class=prompt>&gt;&gt;&gt;</span> conf.color_theme=RastaTheme()
</pre>
<p>
Now, let's manipulate some packets. Here you can see layers that are supported for the moment. It's
really easy to add one.

<pre>
<span class=prompt>&gt;&gt;&gt;</span> ls()
ARP        : ARP
BOOTP      : BOOTP
CookedLinux : cooked linux
DHCP       : DHCP options
DNS        : DNS
DNSQR      : DNS Question Record
DNSRR      : DNS Resource Record
Dot11      : 802.11
Dot11ATIM  : 802.11 ATIM
Dot11AssoReq : 802.11 Association Request
Dot11AssoResp : 802.11 Association Response
Dot11Auth  : 802.11 Authentication
Dot11Beacon : 802.11 Beacon
Dot11Deauth : 802.11 Deauthentication
Dot11Disas : 802.11 Disassociation
Dot11Elt   : 802.11 Information Element
Dot11ProbeReq : 802.11 Probe Request
Dot11ProbeResp : 802.11 Probe Response
Dot11ReassoReq : 802.11 Reassociation Request
Dot11ReassoResp : 802.11 Reassociation Response
Dot11WEP   : 802.11 WEP packet
Dot1Q      : 802.1Q
Dot3       : 802.3
EAP        : EAP
EAPOL      : EAPOL
Ether      : Ethernet
GPRS       : GPRSdummy
HSRP       : HSRP
ICMP       : ICMP
ICMPerror  : ICMP in ICMP
IP         : IP
IPerror    : IP in ICMP
ISAKMP     : ISAKMP
ISAKMP_class : abstract packet
ISAKMP_payload : ISAKMP payload
ISAKMP_payload_Hash : ISAKMP Hash
ISAKMP_payload_ID : ISAKMP Identification
ISAKMP_payload_KE : ISAKMP Key Exchange
ISAKMP_payload_Nonce : ISAKMP Nonce
ISAKMP_payload_Proposal : IKE proposal
ISAKMP_payload_SA : ISAKMP SA
ISAKMP_payload_Transform : IKE Transform
ISAKMP_payload_VendorID : ISAKMP Vendor ID
IrLAPCommand : IrDA Link Access Protocol Command
IrLAPHead  : IrDA Link Access Protocol Header
IrLMP      : IrDA Link Management Protocol
L2CAP      : L2CAP
L2CAP_CmdRej : L2CAP Command Rej
L2CAP_ConfReq : L2CAP Conf Req
L2CAP_ConfResp : L2CAP Conf Resp
L2CAP_ConnReq : L2CAP Conn Req
L2CAP_ConnResp : L2CAP Conn Resp
L2CAP_DisconnReq : L2CAP Disconn Req
L2CAP_DisconnResp : L2CAP Disconn Resp
L2CAP_InfoReq : L2CAP Info Req
L2CAP_InfoResp : L2CAP Info Resp
LLC        : LLC
MGCP       : MGCP
NBNSNodeStatusResponse : NBNS Node Status Response
NBNSNodeStatusResponseEnd : NBNS Node Status Response
NBNSNodeStatusResponseService : NBNS Node Status Response Service
NBNSQueryRequest : NBNS query request
NBNSQueryResponse : NBNS query response
NBNSQueryResponseNegative : NBNS query response (negative)
NBNSRequest : NBNS request
NBNSWackResponse : NBNS Wait for Acknowledgement Response
NBTDatagram : NBT Datagram Packet
NBTSession : NBT Session Packet
NTP        : NTP
NetBIOS_DS : NetBIOS datagram service
PPP        : PPP Link Layer
PPPoE      : PPP over Ethernet
PPPoED     : PPP over Ethernet Discovery
Packet     : abstract packet
Padding    : Padding
PrismHeader : Prism header
RIP        : RIP header
RIPEntry   : RIP entry
Radius     : Radius
Raw        : Raw
SMBMailSlot : SMB Mail Slot Protocol
SMBNegociate_Protocol_Request_Header : SMBNegociate Protocol Request Header
SMBNegociate_Protocol_Request_Tail : SMB Negociate Protocol Request Tail
SMBNegociate_Protocol_Response_Advanced_Security : SMBNegociate Protocol Response Advanced Security
SMBNegociate_Protocol_Response_No_Security : SMBNegociate Protocol Response No Security
SMBNegociate_Protocol_Response_No_Security_No_Key : abstract packet
SMBNetlogon_Protocol_Response_Header : SMBNetlogon Protocol Response Header
SMBNetlogon_Protocol_Response_Tail_LM20 : SMB Netlogon Protocol Response Tail LM20
SMBNetlogon_Protocol_Response_Tail_SAM : SMB Netlogon Protocol Response Tail SAM
SMBSession_Setup_AndX_Request : Session Setup AndX Request
SMBSession_Setup_AndX_Response : Session Setup AndX Response
SNAP       : SNAP
STP        : Spanning Tree Protocol
SebekHead  : Sebek header
SebekV1    : Sebek v1
SebekV2    : Sebek v2
SebekV2Sock : Sebek v2 socket
Skinny     : Skinny
TCP        : TCP
TCPerror   : TCP in ICMP
UDP        : UDP
UDPerror   : UDP in ICMP
</pre>

<pre>
<span class=prompt>&gt;&gt;&gt;</span> IP()
<span>&lt;</span><span class=layer_name>IP</span><span> |</span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> a=IP(dst="172.16.1.40")
<span class=prompt>&gt;&gt;&gt;</span> a
<span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>172.16.1.40</span><span> |</span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> a.dst
'172.16.1.40'
<span class=prompt>&gt;&gt;&gt;</span> a.ttl
64
</pre>



A layer has default values for every field, so that you don't have to fill them all.
If you give a value to the field, it will overload the default value. If you delete the field,
the default value will be back. Moreover, fields with default values are not displayed.

<pre>
<span class=prompt>&gt;&gt;&gt;</span> a.ttl=32
<span class=prompt>&gt;&gt;&gt;</span> a
</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>32</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>172.16.1.40</span><span> |</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> del(a.ttl)
<span class=prompt>&gt;&gt;&gt;</span> a
</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>172.16.1.40</span><span> |</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> a.ttl
64
</pre>


Fields can be made human readable. For example IP and TCP flags : (note the rfc3514 compliance for IP).

<pre>
<span class=prompt>&gt;&gt;&gt;</span> t=TCP()
<span class=prompt>&gt;&gt;&gt;</span> t.flags="SA"
<span class=prompt>&gt;&gt;&gt;</span> t.flags 
18
<span class=prompt>&gt;&gt;&gt;</span> t
<span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>flags</span><span>=</span><span class=field_value>SA</span><span> |</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> t.flags=23
<span class=prompt>&gt;&gt;&gt;</span> t
</span><span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>flags</span><span>=</span><span class=field_value>FSRA</span><span> |</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> i=IP(flags="DF+MF")
<span class=prompt>&gt;&gt;&gt;</span> i.flags
3
<span class=prompt>&gt;&gt;&gt;</span> i
</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>flags</span><span>=</span><span class=field_value>MF+DF</span><span> |</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> i.flags=6
<span class=prompt>&gt;&gt;&gt;</span> i
</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>flags</span><span>=</span><span class=field_value>DF+evil</span><span> |</span>&gt;
</pre>



Some default values are not constant values. For example, the source IP of a packet will default
to the IP of the interface that should be used to send a packet to the given destination, according
to the local routing tables.

<pre>
<span class=prompt>&gt;&gt;&gt;</span> a.dst
'172.16.1.40'
<span class=prompt>&gt;&gt;&gt;</span> a.src
'172.16.1.24'
<span class=prompt>&gt;&gt;&gt;</span> del(a.dst)
<span class=prompt>&gt;&gt;&gt;</span> a.dst
'127.0.0.1'
<span class=prompt>&gt;&gt;&gt;</span> a.src
'127.0.0.1'
<span class=prompt>&gt;&gt;&gt;</span> a.dst="192.168.11.10"
<span class=prompt>&gt;&gt;&gt;</span> a.src
'192.168.11.1'
<span class=prompt>&gt;&gt;&gt;</span> a.dst=target
<span class=prompt>&gt;&gt;&gt;</span> a.src
'172.16.1.24'
<span class=prompt>&gt;&gt;&gt;</span> a.src="1.2.3.4"
<span class=prompt>&gt;&gt;&gt;</span> a
<span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>src</span><span>=</span><span class=emph_field_value>1.2.3.4</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>&lt;Net www.target.com&gt;</span><span> |</span>&gt;
</pre>

Here, you can guess that my routing table looks like :

<pre>
$ route -n 
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
172.16.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0
192.168.11.0    0.0.0.0         255.255.255.0   U     0      0        0 eth1
0.0.0.0         172.16.1.1      0.0.0.0         UG    0      0        0 eth0
</pre>

We will see later that scapy has its own routing table.

<p>
The <tt>/</tt> operator has been used as a composition operator between two layers. When doing so,
the lower layer can have one or more of its defaults fields overloaded according to the upper layer.
(You still can give the value you want). A string can be used as a raw layer.

<pre>
<span class=prompt>&gt;&gt;&gt;</span> IP()
</span><span>&lt;</span><span class=layer_name>IP</span><span> |</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> IP()/TCP()
</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> |</span><span>&gt;</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> Ether()/IP()/TCP()
</span><span>&lt;</span><span class=layer_name>Ether</span><span> </span><span class=field_name>type</span><span>=</span><span class=field_value>0x800</span><span> |</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> |</span><span>&gt;</span><span>&gt;</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> IP()/TCP()/"GET / HTTP/1.0\r\n\r\n"
</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> |</span><span>&lt;</span><span class=layer_name>Raw</span><span> </span><span class=field_name>load</span><span>=</span><span class=field_value>'GET / HTTP/1.0\r\n\r\n'</span><span> |</span><span>&gt;</span><span>&gt;</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> Ether()/IP()/IP()/UDP()
</span><span>&lt;</span><span class=layer_name>Ether</span><span> </span><span class=field_name>type</span><span>=</span><span class=field_value>0x800</span><span> |</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>IP</span><span> |</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>UDP</span><span> |</span><span>&lt;</span><span class=layer_name>UDP</span><span> |</span><span>&gt;</span><span>&gt;</span><span>&gt;</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> IP(proto=55)/TCP()
</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>55</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> |</span><span>&gt;</span><span>&gt;
</pre>

<p>
Each packet can be build or dissected (note: in python <tt>_</tt> (underscode) is the latest result) :

<pre>
<span class=prompt>&gt;&gt;&gt;</span> str(IP())
'E\x00\x00\x14\x00\x01\x00\x00@\x00|\xe7\x7f\x00\x00\x01\x7f\x00\x00\x01'
<span class=prompt>&gt;&gt;&gt;</span> IP(_)
<span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>version</span><span>=</span><span class=field_value>4L</span><span> </span><span class=field_name>ihl</span><span>=</span><span class=field_value>5L</span><span> </span><span class=field_name>tos</span><span>=</span><span class=field_value>0x0</span><span> </span><span class=field_name>len</span><span>=</span><span class=field_value>20</span><span> </span><span class=field_name>id</span><span>=</span><span class=field_value>1</span><span> </span><span class=field_name>flags</span><span>=</span><span class=field_value></span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>64</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>IP</span>
<span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0x7ce7</span><span> </span><span class=emph_field_name>src</span><span>=</span><span class=emph_field_value>127.0.0.1</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>127.0.0.1</span><span> |</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span>  a=Ether()/IP(dst="www.slashdot.org")/TCP()/"GET /index.html HTTP/1.0 \n\n"
<span class=prompt>&gt;&gt;&gt;</span>  hexdump(a)   
00 02 15 37 A2 44 00 AE F3 52 AA D1 08 00 45 00  </span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span>7</span><span class=not_printable>.</span><span>D</span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span>R</span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span>E</span><span class=not_printable>.</span><span>
00 43 00 01 00 00 40 06 78 3C C0 A8 05 15 42 23  </span><span class=not_printable>.</span><span>C</span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span>@</span><span class=not_printable>.</span><span>x<</span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span>B#
FA 97 00 14 00 50 00 00 00 00 00 00 00 00 50 02  </span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span>P</span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span>P</span><span class=not_printable>.</span><span>
20 00 BB 39 00 00 47 45 54 20 2F 69 6E 64 65 78   </span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span>9</span><span class=not_printable>.</span><span></span><span class=not_printable>.</span><span>GET /index
2E 68 74 6D 6C 20 48 54 54 50 2F 31 2E 30 20 0A  .html HTTP/1.0 </span><span class=not_printable>.</span><span>
0A                                               </span><span class=not_printable>.</span><span>
<span class=prompt>&gt;&gt;&gt;</span> b=str(a)
<span class=prompt>&gt;&gt;&gt;</span> b
'\x00\x02\x157\xa2D\x00\xae\xf3R\xaa\xd1\x08\x00E\x00\x00C\x00\x01\x00\x00@\x06x<\xc0
 \xa8\x05\x15B#\xfa\x97\x00\x14\x00P\x00\x00\x00\x00\x00\x00\x00\x00P\x02 \x00
 \xbb9\x00\x00GET /index.html HTTP/1.0 \n\n'
<span class=prompt>&gt;&gt;&gt;</span> c=Ether(b)
<span class=prompt>&gt;&gt;&gt;</span> c
</span><span>&lt;</span><span class=layer_name>Ether</span><span> </span><span class=field_name>dst</span><span>=</span><span class=field_value>00:02:15:37:a2:44</span><span> </span><span class=field_name>src</span><span>=</span><span class=field_value>00:ae:f3:52:aa:d1</span><span> </span><span class=field_name>type</span><span>=</span><span class=field_value>0x800</span><span> |</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>version</span><span>=</span><span class=field_value>4L</span>
<span> </span><span class=field_name>ihl</span><span>=</span><span class=field_value>5L</span><span> </span><span class=field_name>tos</span><span>=</span><span class=field_value>0x0</span><span> </span><span class=field_name>len</span><span>=</span><span class=field_value>67</span><span> </span><span class=field_name>id</span><span>=</span><span class=field_value>1</span><span> </span><span class=field_name>flags</span><span>=</span><span class=field_value></span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>64</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0x783c</span>
<span> </span><span class=emph_field_name>src</span><span>=</span><span class=emph_field_value>192.168.5.21</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.151</span><span> </span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>sport</span><span>=</span><span class=field_value>20</span><span> </span><span class=field_name>dport</span><span>=</span><span class=field_value>80</span><span> </span><span class=field_name>seq</span><span>=</span><span class=field_value>0L</span>
<span> </span><span class=field_name>ack</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>dataofs</span><span>=</span><span class=field_value>5L</span><span> </span><span class=field_name>reserved</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>flags</span><span>=</span><span class=field_value>S</span><span> </span><span class=field_name>window</span><span>=</span><span class=field_value>8192</span><span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0xbb39</span><span> </span><span class=field_name>urgptr</span><span>=</span><span class=field_value>0</span>
<span> </span><span class=field_name>options</span><span>=</span><span class=field_value>[]</span><span> |</span><span>&lt;</span><span class=layer_name>Raw</span><span> </span><span class=field_name>load</span><span>=</span><span class=field_value>'GET /index.html HTTP/1.0 \n\n'</span><span> |</span><span>&gt;</span><span>&gt;</span><span>&gt;</span>&gt;
</pre>

We see that a dissected packet has all its fields filled. That's because I consider that
each field has its value imposed by the original string. If this is too verbose,
the method <tt>hide_defaults()</tt> will delete every field that has the same value 
as the default.

<pre>
<span class=prompt>&gt;&gt;&gt;</span> c.hide_defaults()
<span class=prompt>&gt;&gt;&gt;</span> c
<span>&lt;</span><span class=layer_name>Ether</span><span> </span><span class=field_name>dst</span><span>=</span><span class=field_value>00:0f:66:56:fa:d2</span><span> </span><span class=field_name>src</span><span>=</span><span class=field_value>00:ae:f3:52:aa:d1</span><span> </span><span class=field_name>type</span><span>=</span><span class=field_value>0x800</span><span> |</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>ihl</span><span>=</span><span class=field_value>5L</span><span> </span><span class=field_name>len</span><span>=</span><span class=field_value>67</span>
<span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0x783c</span><span> </span><span class=emph_field_name>src</span><span>=</span><span class=emph_field_value>192.168.5.21</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.151</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>dataofs</span><span>=</span><span class=field_value>5L</span>
<span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0xbb39</span><span> </span><span class=field_name>options</span><span>=</span><span class=field_value>[]</span><span> |</span><span>&lt;</span><span class=layer_name>Raw</span><span> </span><span class=field_name>load</span><span>=</span><span class=field_value>'GET /index.html HTTP/1.0 \n\n'</span><span> |</span><span>&gt;</span><span>&gt;</span><span>&gt;</span>&gt;
</pre>

<p>

You can read packets from a pcap file and write them to a pcap file. You can make a graphical postscript/pdf dump
of a packet or a list of packets (see ugly png image. postcript/pdf are far better quality...).

<pre>
<span class=prompt>&gt;&gt;&gt;</span> a=rdpcap("/spare/captures/isakmp.cap")
<span class=prompt>&gt;&gt;&gt;</span> a
</span><span><</span><span class=packetlist_name>isakmp.cap</span><span>: </span><span class=packetlist_proto>UDP</span><span>:</span><span class=packetlist_value>721</span><span> </span><span class=packetlist_proto>TCP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>ICMP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>Other</span><span>:</span><span class=packetlist_value>0</span><span>>
<span class=prompt>&gt;&gt;&gt;</span> a[423].pdfdump(layer_shift=1)
<span class=prompt>&gt;&gt;&gt;</span> a[423].psdump("/tmp/isakmp_pkt.eps",layer_shift=1)
</pre>

<center> <img  src="img/isakmp_dump.png"> </center>

<p>
For the moment, we have only generated one packet. Let see how to specify sets of packets as easily.
Each field of the whole packet (ever layers) can be a set. This implicidely define a set of packets,
generated using a kind of cartesian product between all the fields.

<pre>
<span class=prompt>&gt;&gt;&gt;</span> a=IP(dst="www.slashdot.org/30")
<span class=prompt>&gt;&gt;&gt;</span> a
<span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value><Net www.slashdot.org/30></span><span> |</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> [p for p in a]
[</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.148</span><span> |</span><span>&gt;, </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.149</span><span> |</span><span>&gt;,
 </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.150</span><span> |</span><span>&gt;, </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.151</span><span> |</span><span>&gt;]
<span class=prompt>&gt;&gt;&gt;</span> b=IP(ttl=[1,2,(5,9)])
<span class=prompt>&gt;&gt;&gt;</span> b
</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>[1, 2, (5, 9)]</span><span> |</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> [p for p in b]
[</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>1</span><span> |</span><span>&gt;, </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>2</span><span> |</span><span>&gt;, </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>5</span><span> |</span><span>&gt;, </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>6</span><span> |</span><span>&gt;, 
 </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>7</span><span> |</span><span>&gt;, </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>8</span><span> |</span><span>&gt;, </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>9</span><span> |</span><span>&gt;]
<span class=prompt>&gt;&gt;&gt;</span> c=TCP(dport=[80,443])
<span class=prompt>&gt;&gt;&gt;</span> [p for p in a/c]
[</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.148</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>dport</span><span>=</span><span class=field_value>80</span><span> |</span><span>&gt;</span><span>&gt;,
 </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.148</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>dport</span><span>=</span><span class=field_value>443</span><span> |</span><span>&gt;</span><span>&gt;,
 </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.149</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>dport</span><span>=</span><span class=field_value>80</span><span> |</span><span>&gt;</span><span>&gt;,
 </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.149</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>dport</span><span>=</span><span class=field_value>443</span><span> |</span><span>&gt;</span><span>&gt;,
 </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.150</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>dport</span><span>=</span><span class=field_value>80</span><span> |</span><span>&gt;</span><span>&gt;,
 </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.150</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>dport</span><span>=</span><span class=field_value>443</span><span> |</span><span>&gt;</span><span>&gt;,
 </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.151</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>dport</span><span>=</span><span class=field_value>80</span><span> |</span><span>&gt;</span><span>&gt;,
 </span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.151</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>dport</span><span>=</span><span class=field_value>443</span><span> |</span><span>&gt;</span>&gt;]
</pre>

Some operations (like building the string from a packet) can't work on a set of packets. 
In these cases, if you forgot to unroll your set of packets, only the first element
of the list you forgot to generate will be used to assemble the packet.

<p>
Now that we know how to manipulate packets. Let's see how to send them. The <tt>send()</tt> function
will send packets at layer 3. That is to say it will handle routing and layer 2 for you. 
The sendp() function will work at layer 2. It's up to you to choose the right interface
and the right link layer protocol.

<pre>
<span class=prompt>&gt;&gt;&gt;</span> send(IP(dst="1.2.3.4")/ICMP())
.
Sent 1 packets.
<span class=prompt>&gt;&gt;&gt;</span> sendp(Ether()/IP(dst="1.2.3.4",ttl=(1,4)), iface="eth1")
....
Sent 4 packets.
<span class=prompt>&gt;&gt;&gt;</span> sendp("I'm travelling on Ethernet", iface="eth1", loop=1, inter=0.2)
................^C
Sent 16 packets.
<span class=prompt>&gt;&gt;&gt;</span> sendp(rdpcap("/tmp/pcapfile")) # tcpreplay
...........
Sent 11 packets.
</pre>

The function <tt>fuzz()</tt> is able to change any default value that
is not to be calculated (like checksums) by an object whose value is
random and whose type is adapted to the field. This enables to quicky
built fuzzing templates and send them in loop. In the following example,
the IP layer is normal, and the UDP and NTP layers are fuzzed. The 
UDP checksum will be correct, the UDP destination port will be overloaded
by NTP to be 123 and the NTP version will be forced to be 4. All the other ports
will be randomized.

<pre>
<span class=prompt>&gt;&gt;&gt;</span> send(IP(dst="target")/fuzz(UDP()/NTP(version=4)),loop=1)
................^C
Sent 16 packets.
</pre>


<p>
Now, let's try to do some fun things. 
The <tt>sr()</tt> function is for sending packets and receiving answers.
The function returns a couple of packet and answers, and the unanswered packets. 
The function <tt>sr1()</tt> is a variant that only return one packet that answered the packet
(or the packet set) sent. The packets must be layer 3 packets (IP, ARP, etc.).
The function <tt>srp()</tt> do the same for layer 2 packets (Ethernet, 802.3, etc.).

<pre>
<span class=prompt>&gt;&gt;&gt;</span> p=sr1(IP(dst="www.slashdot.org")/ICMP()/"XXXXXXXXXXX")
Begin emission:
...Finished to send 1 packets.
.*
Received 5 packets, got 1 answers, remaining 0 packets
<span class=prompt>&gt;&gt;&gt;</span> p
<span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>version</span><span>=</span><span class=field_value>4L</span><span> </span><span class=field_name>ihl</span><span>=</span><span class=field_value>5L</span><span> </span><span class=field_name>tos</span><span>=</span><span class=field_value>0x0</span><span> </span><span class=field_name>len</span><span>=</span><span class=field_value>39</span><span> </span><span class=field_name>id</span><span>=</span><span class=field_value>15489</span><span> </span><span class=field_name>flags</span><span>=</span><span class=field_value></span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>42</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>ICMP</span>
<span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0x51dd</span><span> </span><span class=emph_field_name>src</span><span>=</span><span class=emph_field_value>66.35.250.151</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>192.168.5.21</span><span> </span><span> |</span><span>&lt;</span><span class=layer_name>ICMP</span><span> </span><span class=field_name>type</span><span>=</span><span class=field_value>echo-reply</span>
<span> </span><span class=field_name>code</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0xee45</span><span> </span><span class=field_name>id</span><span>=</span><span class=field_value>0x0</span><span> </span><span class=field_name>seq</span><span>=</span><span class=field_value>0x0</span><span> |</span><span>&lt;</span><span class=layer_name>Raw</span><span> </span><span class=field_name>load</span><span>=</span><span class=field_value>'XXXXXXXXXXX'</span>
<span> |</span><span>&lt;</span><span class=layer_name>Padding</span><span> </span><span class=field_name>load</span><span>=</span><span class=field_value>'\x00\x00\x00\x00'</span><span> |</span><span>&gt;</span><span>&gt;</span><span>&gt;</span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> p.show()
</span><span>---[ </span><span class=layer_name>IP</span><span> ]---
</span><span class=field_name>version   </span><span>= </span><span class=field_value>4L
</span><span class=field_name>ihl       </span><span>= </span><span class=field_value>5L
</span><span class=field_name>tos       </span><span>= </span><span class=field_value>0x0
</span><span class=field_name>len       </span><span>= </span><span class=field_value>39
</span><span class=field_name>id        </span><span>= </span><span class=field_value>15489
</span><span class=field_name>flags     </span><span>= </span><span class=field_value>
</span><span class=field_name>frag      </span><span>= </span><span class=field_value>0L
</span><span class=field_name>ttl       </span><span>= </span><span class=field_value>42
</span><span class=field_name>proto     </span><span>= </span><span class=field_value>ICMP
</span><span class=field_name>chksum    </span><span>= </span><span class=field_value>0x51dd
</span><span class=emph_field_name>src       </span><span>= </span><span class=emph_field_value>66.35.250.151
</span><span class=emph_field_name>dst       </span><span>= </span><span class=emph_field_value>192.168.5.21
</span><span class=field_name>options   </span><span>= </span><span class=field_value>''
</span><span>---[ </span><span class=layer_name>ICMP</span><span> ]---
   </span><span class=field_name>type      </span><span>= </span><span class=field_value>echo-reply
   </span><span class=field_name>code      </span><span>= </span><span class=field_value>0
   </span><span class=field_name>chksum    </span><span>= </span><span class=field_value>0xee45
   </span><span class=field_name>id        </span><span>= </span><span class=field_value>0x0
   </span><span class=field_name>seq       </span><span>= </span><span class=field_value>0x0
</span><span>---[ </span><span class=layer_name>Raw</span><span> ]---
      </span><span class=field_name>load      </span><span>= </span><span class=field_value>'XXXXXXXXXXX'
</span><span>---[ </span><span class=layer_name>Padding</span><span> ]---
         </span><span class=field_name>load      </span><span>= </span><span class=field_value>'\x00\x00\x00\x00'
</pre>

<p>
A DNS query (rd = recursion desired). Note the non-null padding coming from 
my Linksys having the Etherleak flaw.
<pre>
<span class=prompt>&gt;&gt;&gt;</span> sr1(IP(dst="192.168.5.1")/UDP()/DNS(rd=1,qd=DNSQR(qname="www.slashdot.org")))
Begin emission:
Finished to send 1 packets.
..*
Received 3 packets, got 1 answers, remaining 0 packets
<span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>version</span><span>=</span><span class=field_value>4L</span><span> </span><span class=field_name>ihl</span><span>=</span><span class=field_value>5L</span><span> </span><span class=field_name>tos</span><span>=</span><span class=field_value>0x0</span><span> </span><span class=field_name>len</span><span>=</span><span class=field_value>78</span><span> </span><span class=field_name>id</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>flags</span><span>=</span><span class=field_value>DF</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>64</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>UDP</span><span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0xaf38</span>
<span> </span><span class=emph_field_name>src</span><span>=</span><span class=emph_field_value>192.168.5.1</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>192.168.5.21</span><span> </span><span class=field_name>options</span><span>=</span><span class=field_value>''</span><span> |</span><span>&lt;</span><span class=layer_name>UDP</span><span> </span><span class=field_name>sport</span><span>=</span><span class=field_value>53</span><span> </span><span class=field_name>dport</span><span>=</span><span class=field_value>53</span><span> </span><span class=field_name>len</span><span>=</span><span class=field_value>58</span><span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0xd55d</span>
<span> |</span><span>&lt;</span><span class=layer_name>DNS</span><span> </span><span class=field_name>id</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>qr</span><span>=</span><span class=field_value>1L</span><span> </span><span class=field_name>opcode</span><span>=</span><span class=field_value>QUERY</span><span> </span><span class=field_name>aa</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>tc</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>rd</span><span>=</span><span class=field_value>1L</span><span> </span><span class=field_name>ra</span><span>=</span><span class=field_value>1L</span><span> </span><span class=field_name>z</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>rcode</span><span>=</span><span class=field_value>ok</span><span> </span><span class=field_name>qdcount</span><span>=</span><span class=field_value>1</span><span> </span><span class=field_name>ancount</span><span>=</span><span class=field_value>1</span>
<span> </span><span class=field_name>nscount</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>arcount</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>qd</span><span>=</span><span class=field_value></span><span>&lt;</span><span class=layer_name>DNSQR</span><span> </span><span class=field_name>qname</span><span>=</span><span class=field_value>'www.slashdot.org.'</span><span> </span><span class=field_name>qtype</span><span>=</span><span class=field_value>A</span><span> </span><span class=field_name>qclass</span><span>=</span><span class=field_value>IN</span><span> |</span><span>&gt;</span><span> </span>
 <span class=field_name>an</span><span>=</span><span class=field_value></span><span>&lt;</span><span class=layer_name>DNSRR</span><span> </span><span class=field_name>rrname</span><span>=</span><span class=field_value>'www.slashdot.org.'</span><span> </span><span class=field_name>type</span><span>=</span><span class=field_value>A</span><span> </span><span class=field_name>rclass</span><span>=</span><span class=field_value>IN</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>3560L</span><span> </span><span class=field_name>rdata</span><span>=</span><span class=field_value>'66.35.250.151'</span><span> |</span><span>&gt;</span>
<span> </span><span class=field_name>ns</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>ar</span><span>=</span><span class=field_value>0</span><span> |</span><span>&lt;</span><span class=layer_name>Padding</span><span> </span><span class=field_name>load</span><span>=</span><span class=field_value>'\xc6\x94\xc7\xeb'</span><span> |</span><span>&gt;</span><span>&gt;</span><span>&gt;</span>&gt;
</pre>

<p>
The "send'n'receive" functions family is the heart of scapy. They return a couple of
two lists. The first element is a list of couples (packet sent, answer), and the
second element is the list of unanswered packets. These two elements are lists, but
they are wrapped by an object to present them better, and to provide them with some
methods that do most frequently needed actions.
<pre>
<span class=prompt>&gt;&gt;&gt;</span> sr(IP(dst="192.168.8.1")/TCP(dport=[21,22,23]))
Received 6 packets, got 3 answers, remaining 0 packets
(<span>&lt;</span><span class=packetlist_name>Results</span><span>: </span><span class=packetlist_proto>UDP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>TCP</span><span>:</span><span class=packetlist_value>3</span><span> </span><span class=packetlist_proto>ICMP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>Other</span><span>:</span><span class=packetlist_value>0</span><span>&gt;, </span><span>&lt;</span><span class=packetlist_name>Unanswered</span><span>: </span><span class=packetlist_proto>UDP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>TCP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>ICMP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>Other</span><span>:</span><span class=packetlist_value>0</span>&gt;)
<span class=prompt>&gt;&gt;&gt;</span> ans,unans=_
<span class=prompt>&gt;&gt;&gt;</span> ans.summary()
IP / TCP 192.168.8.14:20 &gt; 192.168.8.1:21 S ==&gt; Ether / IP / TCP 192.168.8.1:21 &gt; 192.168.8.14:20 RA / Padding
IP / TCP 192.168.8.14:20 &gt; 192.168.8.1:22 S ==&gt; Ether / IP / TCP 192.168.8.1:22 &gt; 192.168.8.14:20 RA / Padding
IP / TCP 192.168.8.14:20 &gt; 192.168.8.1:23 S ==&gt; Ether / IP / TCP 192.168.8.1:23 &gt; 192.168.8.14:20 RA / Padding
</pre>
If there is a limited rate of answers, you can specify
a time interval to wait between two packets with the <tt>inter</tt> parameter.
If some packets are lost or if specifying an interval is not enough, you can
resend all the unanswered packets, either by calling the function again, directly
with the unanswered list, or by specifying a <tt>retry</tt> parameter.
If retry is 3, scapy will try to resend unanswered packets 3 times.
If retry is -3, scapy will resend unanswered packets until no more answer is given
for the same set of unanswered packets 3 times in a row. The <tt>timeout</tt> parameter
specify the time to wait after the last packet has been sent.

<pre>
<span class=prompt>&gt;&gt;&gt;</span> sr(IP(dst="172.20.29.5/30")/TCP(dport=[21,22,23]),inter=0.5,retry=-2,timeout=1)
Begin emission:
Finished to send 12 packets.
Begin emission:
Finished to send 9 packets.
Begin emission:
Finished to send 9 packets.

Received 100 packets, got 3 answers, remaining 9 packets
(<span>&lt;</span><span class=packetlist_name>Results</span><span>: </span><span class=packetlist_proto>UDP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>TCP</span><span>:</span><span class=packetlist_value>3</span><span> </span><span class=packetlist_proto>ICMP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>Other</span><span>:</span><span class=packetlist_value>0</span><span>&gt;, </span><span>&lt;</span><span class=packetlist_name>Unanswered</span><span>: </span><span class=packetlist_proto>UDP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>TCP</span><span>:</span><span class=packetlist_value>9</span><span> </span><span class=packetlist_proto>ICMP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>Other</span><span>:</span><span class=packetlist_value>0</span>&gt;)

</pre>



<p>
A TCP traceroute.
<pre>
<span class=prompt>&gt;&gt;&gt;</span> ans,unans=sr(IP(dst=target, ttl=(4,25),id=RandShort())/TCP(flags=0x2))
*****.******.*.***..*.**Finished to send 22 packets.
***......
Received 33 packets, got 21 answers, remaining 1 packets
<span class=prompt>&gt;&gt;&gt;</span> for snd,rcv in ans:
...     print snd.ttl, rcv.src, isinstance(rcv.payload, TCP)
... 
5 194.51.159.65 0
6 194.51.159.49 0
4 194.250.107.181 0
7 193.251.126.34 0
8 193.251.126.154 0
9 193.251.241.89 0
10 193.251.241.110 0
11 193.251.241.173 0
13 208.172.251.165 0
12 193.251.241.173 0
14 208.172.251.165 0
15 206.24.226.99 0
16 206.24.238.34 0
17 173.109.66.90 0
18 173.109.88.218 0
19 173.29.39.101 1
20 173.29.39.101 1
21 173.29.39.101 1
22 173.29.39.101 1
23 173.29.39.101 1
24 173.29.39.101 1
</pre>
Note that the TCP traceroute and some other high-level functions are already coded :
<pre>
<span class=prompt>&gt;&gt;&gt;</span> lsc()
sr               : Send and receive packets at layer 3
sr1              : Send packets at layer 3 and return only the first answer
srp              : Send and receive packets at layer 2
srp1             : Send and receive packets at layer 2 and return only the first answer
srloop           : Send a packet at layer 3 in loop and print the answer each time
srploop          : Send a packet at layer 2 in loop and print the answer each time
sniff            : Sniff packets
p0f              : Passive OS fingerprinting: which OS emitted this TCP SYN ?
arpcachepoison   : Poison target's cache with (your MAC,victim's IP) couple
send             : Send packets at layer 3
sendp            : Send packets at layer 2
traceroute       : Instant TCP traceroute
arping           : Send ARP who-has requests to determine which hosts are up
ls               : List  available layers, or infos on a given layer
lsc              : List user commands
queso            : Queso OS fingerprinting
nmap_fp          : nmap fingerprinting
report_ports     : portscan a target and output a LaTeX table
dyndns_add       : Send a DNS add message to a nameserver for "name" to have a new "rdata"
dyndns_del       : Send a DNS delete message to a nameserver for "name"
</pre>


<p>
The process of sending packets and receiving is quite complicated. As I wanted to use the PF_PACKET
interface to go through netfilter, I also needed to implement an ARP stack and ARP cache, and a LL
stack. Well it seems to work, on ethernet and PPP interfaces, but I don't guarantee anything.
Anyway, the fact I used a kind of super-socket for that mean that you can switch your IO layer 
very easily, and use PF_INET/SOCK_RAW, or use PF_PACKET at level 2 (giving the LL header (ethernet,...)
and giving yourself mac addresses, ...). 
I've just added a super socket which use libdnet and libpcap, so that it should be portable :

<pre>
<span class=prompt>&gt;&gt;&gt;</span> conf.L3socket=L3dnetSocket
<span class=prompt>&gt;&gt;&gt;</span> conf.L3listen=L3pcapListenSocket
</pre>


<p>

We can easily capture some packets or even clone tcpdump or tethereal. If no interface is given,
sniffing will happen on every interfaces.

<pre>
<span class=prompt>&gt;&gt;&gt;</span>  sniff(filter="icmp and host 66.35.250.151", count=2)
<span>&lt;</span><span class=packetlist_name>Sniffed</span><span>: </span><span class=packetlist_proto>UDP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>TCP</span><span>:</span><span class=packetlist_value>0</span><span> </span><span class=packetlist_proto>ICMP</span><span>:</span><span class=packetlist_value>2</span><span> </span><span class=packetlist_proto>Other</span><span>:</span><span class=packetlist_value>0</span><span>&gt;
<span class=prompt>&gt;&gt;&gt;</span>  a=_
<span class=prompt>&gt;&gt;&gt;</span>  a.nsummary()
0000 Ether / IP / ICMP 192.168.5.21 echo-request 0 / Raw
0001 Ether / IP / ICMP 192.168.5.21 echo-request 0 / Raw
<span class=prompt>&gt;&gt;&gt;</span>  a[1]
</span><span>&lt;</span><span class=layer_name>Ether</span><span> </span><span class=field_name>dst</span><span>=</span><span class=field_value>00:ae:f3:52:aa:d1</span><span> </span><span class=field_name>src</span><span>=</span><span class=field_value>00:02:15:37:a2:44</span><span> </span><span class=field_name>type</span><span>=</span><span class=field_value>0x800</span><span> |</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>version</span><span>=</span><span class=field_value>4L</span>
<span> </span><span class=field_name>ihl</span><span>=</span><span class=field_value>5L</span><span> </span><span class=field_name>tos</span><span>=</span><span class=field_value>0x0</span><span> </span><span class=field_name>len</span><span>=</span><span class=field_value>84</span><span> </span><span class=field_name>id</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>flags</span><span>=</span><span class=field_value>DF</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>64</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>ICMP</span><span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0x3831</span>
<span> </span><span class=emph_field_name>src</span><span>=</span><span class=emph_field_value>192.168.5.21</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>66.35.250.151</span><span> </span><span class=field_name>options</span><span>=</span><span class=field_value>''</span><span> |</span><span>&lt;</span><span class=layer_name>ICMP</span><span> </span><span class=field_name>type</span><span>=</span><span class=field_value>echo-request</span><span> </span><span class=field_name>code</span><span>=</span><span class=field_value>0</span>
<span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0x6571</span><span> </span><span class=field_name>id</span><span>=</span><span class=field_value>0x8745</span><span> </span><span class=field_name>seq</span><span>=</span><span class=field_value>0x0</span><span> |</span><span>&lt;</span><span class=layer_name>Raw</span><span> </span><span class=field_name>load</span><span>=</span><span class=field_value>'B\xf7g\xda\x00\x07um\x08\t\n\x0b
 \x0c\r\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d
 \x1e\x1f !\x22#$%&\'()*+,-./01234567'</span><span> |</span><span>&gt;</span><span>&gt;</span><span>&gt;</span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> sniff(iface="wifi0", prn=lambda x: x.summary())
802.11 Management 8 ff:ff:ff:ff:ff:ff / 802.11 Beacon / Info SSID / Info Rates / Info DSset / Info TIM / Info 133
802.11 Management 4 ff:ff:ff:ff:ff:ff / 802.11 Probe Request / Info SSID / Info Rates
802.11 Management 5 00:0a:41:ee:a5:50 / 802.11 Probe Response / Info SSID / Info Rates / Info DSset / Info 133
802.11 Management 4 ff:ff:ff:ff:ff:ff / 802.11 Probe Request / Info SSID / Info Rates
802.11 Management 4 ff:ff:ff:ff:ff:ff / 802.11 Probe Request / Info SSID / Info Rates
802.11 Management 8 ff:ff:ff:ff:ff:ff / 802.11 Beacon / Info SSID / Info Rates / Info DSset / Info TIM / Info 133
802.11 Management 11 00:07:50:d6:44:3f / 802.11 Authentication
802.11 Management 11 00:0a:41:ee:a5:50 / 802.11 Authentication
802.11 Management 0 00:07:50:d6:44:3f / 802.11 Association Request / Info SSID / Info Rates / Info 133 / Info 149
802.11 Management 1 00:0a:41:ee:a5:50 / 802.11 Association Response / Info Rates / Info 133 / Info 149
802.11 Management 8 ff:ff:ff:ff:ff:ff / 802.11 Beacon / Info SSID / Info Rates / Info DSset / Info TIM / Info 133
802.11 Management 8 ff:ff:ff:ff:ff:ff / 802.11 Beacon / Info SSID / Info Rates / Info DSset / Info TIM / Info 133
802.11 / LLC / SNAP / ARP who has 172.20.70.172 says 172.20.70.171 / Padding
802.11 / LLC / SNAP / ARP is at 00:0a:b7:4b:9c:dd says 172.20.70.172 / Padding
802.11 / LLC / SNAP / IP / ICMP echo-request 0 / Raw
802.11 / LLC / SNAP / IP / ICMP echo-reply 0 / Raw
<span class=prompt>&gt;&gt;&gt;</span> sniff(iface="eth1", prn=lambda x: x.show())
<span>---[ </span><span class=layer_name>Ethernet</span><span> ]---
</span><span class=field_name>dst       </span><span>= </span><span class=field_value>00:ae:f3:52:aa:d1
</span><span class=field_name>src       </span><span>= </span><span class=field_value>00:02:15:37:a2:44
</span><span class=field_name>type      </span><span>= </span><span class=field_value>0x800
</span><span>---[ </span><span class=layer_name>IP</span><span> ]---
   </span><span class=field_name>version   </span><span>= </span><span class=field_value>4L
   </span><span class=field_name>ihl       </span><span>= </span><span class=field_value>5L
   </span><span class=field_name>tos       </span><span>= </span><span class=field_value>0x0
   </span><span class=field_name>len       </span><span>= </span><span class=field_value>84
   </span><span class=field_name>id        </span><span>= </span><span class=field_value>0
   </span><span class=field_name>flags     </span><span>= </span><span class=field_value>DF
   </span><span class=field_name>frag      </span><span>= </span><span class=field_value>0L
   </span><span class=field_name>ttl       </span><span>= </span><span class=field_value>64
   </span><span class=field_name>proto     </span><span>= </span><span class=field_value>ICMP
   </span><span class=field_name>chksum    </span><span>= </span><span class=field_value>0x3831
   </span><span class=emph_field_name>src       </span><span>= </span><span class=emph_field_value>192.168.5.21</span>
   <span class=emph_field_name>dst       </span><span>= </span><span class=emph_field_value>66.35.250.151</span>
   <span class=field_name>options   </span><span>= </span><span class=field_value>''
</span><span>---[ </span><span class=layer_name>ICMP</span><span> ]---
      </span><span class=field_name>type      </span><span>= </span><span class=field_value>echo-request
      </span><span class=field_name>code      </span><span>= </span><span class=field_value>0
      </span><span class=field_name>chksum    </span><span>= </span><span class=field_value>0x89d9
      </span><span class=field_name>id        </span><span>= </span><span class=field_value>0xc245
      </span><span class=field_name>seq       </span><span>= </span><span class=field_value>0x0
</span><span>---[ </span><span class=layer_name>Raw</span><span> ]---
         </span><span class=field_name>load      </span><span>= </span><span class=field_value>'B\xf7i\xa9\x00\x04\x149\x08\t\n\x0b\x0c\r\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f !\x22#$%&\'()*+,-./01234567'
</span><span>---[ </span><span class=layer_name>Ethernet</span><span> ]---
</span><span class=field_name>dst       </span><span>= </span><span class=field_value>00:02:15:37:a2:44
</span><span class=field_name>src       </span><span>= </span><span class=field_value>00:ae:f3:52:aa:d1
</span><span class=field_name>type      </span><span>= </span><span class=field_value>0x800
</span><span>---[ </span><span class=layer_name>IP</span><span> ]---
   </span><span class=field_name>version   </span><span>= </span><span class=field_value>4L
   </span><span class=field_name>ihl       </span><span>= </span><span class=field_value>5L
   </span><span class=field_name>tos       </span><span>= </span><span class=field_value>0x0
   </span><span class=field_name>len       </span><span>= </span><span class=field_value>84
   </span><span class=field_name>id        </span><span>= </span><span class=field_value>2070
   </span><span class=field_name>flags     </span><span>= </span><span class=field_value>
   </span><span class=field_name>frag      </span><span>= </span><span class=field_value>0L
   </span><span class=field_name>ttl       </span><span>= </span><span class=field_value>42
   </span><span class=field_name>proto     </span><span>= </span><span class=field_value>ICMP
   </span><span class=field_name>chksum    </span><span>= </span><span class=field_value>0x861b
   </span><span class=emph_field_name>src       </span><span>= </span><span class=emph_field_value>66.35.250.151</span>
   <span class=emph_field_name>dst       </span><span>= </span><span class=emph_field_value>192.168.5.21</span>
   <span class=field_name>options   </span><span>= </span><span class=field_value>''
</span><span>---[ </span><span class=layer_name>ICMP</span><span> ]---
      </span><span class=field_name>type      </span><span>= </span><span class=field_value>echo-reply
      </span><span class=field_name>code      </span><span>= </span><span class=field_value>0
      </span><span class=field_name>chksum    </span><span>= </span><span class=field_value>0x91d9
      </span><span class=field_name>id        </span><span>= </span><span class=field_value>0xc245
      </span><span class=field_name>seq       </span><span>= </span><span class=field_value>0x0
</span><span>---[ </span><span class=layer_name>Raw</span><span> ]---
         </span><span class=field_name>load      </span><span>= </span><span class=field_value>'B\xf7i\xa9\x00\x04\x149\x08\t\n\x0b\x0c\r\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f !\x22#$%&\'()*+,-./01234567'
</span><span>---[ </span><span class=layer_name>Padding</span><span> ]---
            </span><span class=field_name>load      </span><span>= </span><span class=field_value>'\n_\x00\x0b'</span>
</pre>

<p>
We can sniff and do passive OS fingerprinting.
<pre>
<span class=prompt>&gt;&gt;&gt;</span> p
<span>&lt;</span><span class=layer_name>Ether</span><span> </span><span class=field_name>dst</span><span>=</span><span class=field_value>00:10:4b:b3:7d:4e</span><span> </span><span class=field_name>src</span><span>=</span><span class=field_value>00:40:33:96:7b:60</span><span> </span><span class=field_name>type</span><span>=</span><span class=field_value>0x800</span><span> |</span><span>&lt;</span><span class=layer_name>IP</span><span> </span><span class=field_name>version</span><span>=</span><span class=field_value>4L</span>
<span> </span><span class=field_name>ihl</span><span>=</span><span class=field_value>5L</span><span> </span><span class=field_name>tos</span><span>=</span><span class=field_value>0x0</span><span> </span><span class=field_name>len</span><span>=</span><span class=field_value>60</span><span> </span><span class=field_name>id</span><span>=</span><span class=field_value>61681</span><span> </span><span class=field_name>flags</span><span>=</span><span class=field_value>DF</span><span> </span><span class=field_name>frag</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>ttl</span><span>=</span><span class=field_value>64</span><span> </span><span class=field_name>proto</span><span>=</span><span class=field_value>TCP</span><span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0xb85e</span>
<span> </span><span class=emph_field_name>src</span><span>=</span><span class=emph_field_value>192.168.8.10</span><span> </span><span class=emph_field_name>dst</span><span>=</span><span class=emph_field_value>192.168.8.1</span><span> </span><span class=field_name>options</span><span>=</span><span class=field_value>''</span><span> |</span><span>&lt;</span><span class=layer_name>TCP</span><span> </span><span class=field_name>sport</span><span>=</span><span class=field_value>46511</span><span> </span><span class=field_name>dport</span><span>=</span><span class=field_value>80</span>
<span> </span><span class=field_name>seq</span><span>=</span><span class=field_value>2023566040L</span><span> </span><span class=field_name>ack</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>dataofs</span><span>=</span><span class=field_value>10L</span><span> </span><span class=field_name>reserved</span><span>=</span><span class=field_value>0L</span><span> </span><span class=field_name>flags</span><span>=</span><span class=field_value>SEC</span><span> </span><span class=field_name>window</span><span>=</span><span class=field_value>5840</span>
<span> </span><span class=field_name>chksum</span><span>=</span><span class=field_value>0x570c</span><span> </span><span class=field_name>urgptr</span><span>=</span><span class=field_value>0</span><span> </span><span class=field_name>options</span><span>=</span><span class=field_value>[('Timestamp', (342940201L, 0L)), ('MSS', 1460),
 ('NOP', ()), ('SAckOK', ''), ('WScale', 0)]</span><span> |</span><span>&gt;</span><span>&gt;</span>&gt;
<span class=prompt>&gt;&gt;&gt;</span> p0f(p)
(1.0, ['Linux 2.4.2 - 2.4.14 (1)'])
<span class=prompt>&gt;&gt;&gt;</span> a=sniff(prn=prnp0f)
(1.0, ['Linux 2.4.2 - 2.4.14 (1)'])
(1.0, ['Linux 2.4.2 - 2.4.14 (1)'])
(0.875, ['Linux 2.4.2 - 2.4.14 (1)', 'Linux 2.4.10 (1)', 'Windows 98 (?)'])
(1.0, ['Windows 2000 (9)'])
</pre>
The number before the OS guess is the accurracy of the guess.
<p>
Demo of both bpf filter and <tt>sprintf()</tt> method :
<pre>
<span class=prompt>&gt;&gt;&gt;</span> a=sniff(filter="tcp and ( port 25 or port 110 )",
 prn=lambda x: x.sprintf("%IP.src%:%TCP.sport% -&gt; %IP.dst%:%TCP.dport%  %2s,TCP.flags% : %TCP.payload%"))
192.168.8.10:47226 -&gt; 213.228.0.14:110   S : 
213.228.0.14:110 -&gt; 192.168.8.10:47226  SA : 
192.168.8.10:47226 -&gt; 213.228.0.14:110   A : 
213.228.0.14:110 -&gt; 192.168.8.10:47226  PA : +OK &lt;13103.1048117923@pop2-1.free.fr&gt;

192.168.8.10:47226 -&gt; 213.228.0.14:110   A : 
192.168.8.10:47226 -&gt; 213.228.0.14:110  PA : USER toto

213.228.0.14:110 -&gt; 192.168.8.10:47226   A : 
213.228.0.14:110 -&gt; 192.168.8.10:47226  PA : +OK 

192.168.8.10:47226 -&gt; 213.228.0.14:110   A : 
192.168.8.10:47226 -&gt; 213.228.0.14:110  PA : PASS tata

213.228.0.14:110 -&gt; 192.168.8.10:47226  PA : -ERR authorization failed

192.168.8.10:47226 -&gt; 213.228.0.14:110   A : 
213.228.0.14:110 -&gt; 192.168.8.10:47226  FA : 
192.168.8.10:47226 -&gt; 213.228.0.14:110  FA : 
213.228.0.14:110 -&gt; 192.168.8.10:47226   A : 
</pre>

<p>
Here is an example of a (h)ping-like functionnality : you always
send the same set of packets to see if something change :


<pre>
<span class=prompt>&gt;&gt;&gt;</span> srloop(IP(dst="www.target.com/30")/TCP())
</span><span class=success>RECV 1:</span><span class=odd> Ether / IP / TCP 192.168.11.99:80 &gt; 192.168.8.14:20 SA / Padding
</span><span class=fail>fail 3:</span><span class=odd> IP / TCP 192.168.8.14:20 &gt; 192.168.11.96:80 S
        IP / TCP 192.168.8.14:20 &gt; 192.168.11.98:80 S
        IP / TCP 192.168.8.14:20 &gt; 192.168.11.97:80 S
</span><span class=success>RECV 1:</span><span class=even> Ether / IP / TCP 192.168.11.99:80 &gt; 192.168.8.14:20 SA / Padding
</span><span class=fail>fail 3:</span><span class=even> IP / TCP 192.168.8.14:20 &gt; 192.168.11.96:80 S
        IP / TCP 192.168.8.14:20 &gt; 192.168.11.98:80 S
        IP / TCP 192.168.8.14:20 &gt; 192.168.11.97:80 S
</span><span class=success>RECV 1:</span><span class=odd> Ether / IP / TCP 192.168.11.99:80 &gt; 192.168.8.14:20 SA / Padding
</span><span class=fail>fail 3:</span><span class=odd> IP / TCP 192.168.8.14:20 &gt; 192.168.11.96:80 S
        IP / TCP 192.168.8.14:20 &gt; 192.168.11.98:80 S
        IP / TCP 192.168.8.14:20 &gt; 192.168.11.97:80 S
</span><span class=success>RECV 1:</span><span class=even> Ether / IP / TCP 192.168.11.99:80 &gt; 192.168.8.14:20 SA / Padding
</span><span class=fail>fail 3:</span><span class=even> IP / TCP 192.168.8.14:20 &gt; 192.168.11.96:80 S
        IP / TCP 192.168.8.14:20 &gt; 192.168.11.98:80 S
        IP / TCP 192.168.8.14:20 &gt; 192.168.11.97:80 S
</pre>
<p>
Now we have a demonstration of the <tt>make_table()</tt>  presentation function.
It takes a list as parameter, and a function who returns a 3-uple. The first element is the value on the
<em>x</em> axis from an element of the list, the second is about the <em>y</em> value
and the third is the value that we want to see at coordinates (<em>x</em>,<em>y</em>).
The result is a table. This function has 2 variants, <tt>make_lined_table()</tt> and
<tt>make_tex_table()</tt> to copy/paste into your LaTeX pentest report.
Those functions are available as methods of a result object :
<p>
Here we can see a multi-parallel traceroute (scapy already has a multi TCP 
traceroute function. See later).
<pre>
<span class=prompt>&gt;&gt;&gt;</span> ans,unans=sr(IP(dst="www.test.fr/30", ttl=(1,6))/TCP())
Received 49 packets, got 24 answers, remaining 0 packets
<span class=prompt>&gt;&gt;&gt;</span> ans.make_table( lambda (s,r): (s.dst, s.ttl, r.src) )
  216.15.189.192  216.15.189.193  216.15.189.194  216.15.189.195  
1 192.168.8.1     192.168.8.1     192.168.8.1     192.168.8.1     
2 81.57.239.254   81.57.239.254   81.57.239.254   81.57.239.254   
3 213.228.4.254   213.228.4.254   213.228.4.254   213.228.4.254   
4 213.228.3.3     213.228.3.3     213.228.3.3     213.228.3.3     
5 193.251.254.1   193.251.251.69  193.251.254.1   193.251.251.69  
6 193.251.241.174 193.251.241.178 193.251.241.174 193.251.241.178 
</pre>

Here is a more complex example to identify machines from their IPID field. We 
can see that 172.20.80.200:22 is answered by the same IP stack than 172.20.80.201
and that 172.20.80.197:25 is not answered by the sape IP stack than other ports on 
the same IP.
<pre>
<span class=prompt>&gt;&gt;&gt;</span> ans,unans=sr(IP(dst="172.20.80.192/28")/TCP(dport=[20,21,22,25,53,80]))
Received 142 packets, got 25 answers, remaining 71 packets
<span class=prompt>&gt;&gt;&gt;</span> ans.make_table(lambda (s,r): (s.dst, s.dport, r.sprintf("%IP.id%")))
   172.20.80.196 172.20.80.197 172.20.80.198 172.20.80.200 172.20.80.201 
20 0             4203          7021          -             11562             
21 0             4204          7022          -             11563             
22 0             4205          7023          11561         11564             
25 0             0             7024          -             11565             
53 0             4207          7025          -             11566             
80 0             4028          7026          -             11567             
</pre>

It can help identify network topologies very easily when playing with TTL,
displaying received TTL, etc. 

<p>

Now scapy has its own routing table, so that you can have your packets routed diffrently
than the system.
<pre>
<span class=prompt>&gt;&gt;&gt;</span> conf.route
Network         Netmask         Gateway         Iface
127.0.0.0       255.0.0.0       0.0.0.0         lo
192.168.8.0     255.255.255.0   0.0.0.0         eth0
0.0.0.0         0.0.0.0         192.168.8.1     eth0
<span class=prompt>&gt;&gt;&gt;</span> conf.route.delt(net="0.0.0.0/0",gw="192.168.8.1")
<span class=prompt>&gt;&gt;&gt;</span> conf.route.add(net="0.0.0.0/0",gw="192.168.8.254")
<span class=prompt>&gt;&gt;&gt;</span> conf.route.add(host="192.168.1.1",gw="192.168.8.1")
<span class=prompt>&gt;&gt;&gt;</span> conf.route
Network         Netmask         Gateway         Iface
127.0.0.0       255.0.0.0       0.0.0.0         lo
192.168.8.0     255.255.255.0   0.0.0.0         eth0
0.0.0.0         0.0.0.0         192.168.8.254   eth0
192.168.1.1     255.255.255.255 192.168.8.1     eth0
<span class=prompt>&gt;&gt;&gt;</span> conf.route.resync()
<span class=prompt>&gt;&gt;&gt;</span> conf.route
Network         Netmask         Gateway         Iface
127.0.0.0       255.0.0.0       0.0.0.0         lo
192.168.8.0     255.255.255.0   0.0.0.0         eth0
0.0.0.0         0.0.0.0         192.168.8.1     eth0
</pre>

<p>
We can easily plot some harvested values using Gnuplot. For example, we can
observe the IP ID patterns to know how many distinct IP stacks are used
behind a load balancer :

<pre>
<span class=prompt>&gt;&gt;&gt;</span> a,b=sr(IP(dst="www.target.com")/TCP(sport=[RandShort()]*1000))
<span class=prompt>&gt;&gt;&gt;</span> a.plot(lambda x:x[1].id)
&lt;Gnuplot._Gnuplot.Gnuplot instance at 0xb7d6a74c&gt;
</pre>

<center> <img src="img/ipid.png"> </center>

<p>
Scapy also has a powerful TCP traceroute function. Unlike other traceroute programs
that wait for each node to reply before going to the next, scapy sends all the packets
at the same time. This has the disadvantage that it can't know when to stop (thus the
<tt>maxttl</tt> parameter) but the great advantage that it took less than 3 seconds
to get this multi-target traceroute result :
<pre>
<span class=prompt>&gt;&gt;&gt;</span> traceroute(["www.yahoo.com","www.altavista.com","www.wisenut.com","www.copernic.com"],maxttl=20)
Received 80 packets, got 80 answers, remaining 0 packets
   193.45.10.88:80    216.109.118.79:80  64.241.242.243:80  66.94.229.254:80   
1  192.168.8.1        192.168.8.1        192.168.8.1        192.168.8.1        
2  82.243.5.254       82.243.5.254       82.243.5.254       82.243.5.254     
3  213.228.4.254      213.228.4.254      213.228.4.254      213.228.4.254      
4  212.27.50.46       212.27.50.46       212.27.50.46       212.27.50.46       
5  212.27.50.37       212.27.50.41       212.27.50.37       212.27.50.41       
6  212.27.50.34       212.27.50.34       213.228.3.234      193.251.251.69     
7  213.248.71.141     217.118.239.149    208.184.231.214    193.251.241.178    
8  213.248.65.81      217.118.224.44     64.125.31.129      193.251.242.98     
9  213.248.70.14      213.206.129.85     64.125.31.186      193.251.243.89     
10 193.45.10.88    SA 213.206.128.160    64.125.29.122      193.251.254.126    
11 193.45.10.88    SA 206.24.169.41      64.125.28.70       216.115.97.178     
12 193.45.10.88    SA 206.24.226.99      64.125.28.209      66.218.64.146      
13 193.45.10.88    SA 206.24.227.106     64.125.29.45       66.218.82.230      
14 193.45.10.88    SA 216.109.74.30      64.125.31.214      66.94.229.254   SA 
15 193.45.10.88    SA 216.109.120.149    64.124.229.109     66.94.229.254   SA 
16 193.45.10.88    SA 216.109.118.79  SA 64.241.242.243  SA 66.94.229.254   SA 
17 193.45.10.88    SA 216.109.118.79  SA 64.241.242.243  SA 66.94.229.254   SA 
18 193.45.10.88    SA 216.109.118.79  SA 64.241.242.243  SA 66.94.229.254   SA 
19 193.45.10.88    SA 216.109.118.79  SA 64.241.242.243  SA 66.94.229.254   SA 
20 193.45.10.88    SA 216.109.118.79  SA 64.241.242.243  SA 66.94.229.254   SA 
(&lt;Traceroute: UDP:0 TCP:28 ICMP:52 Other:0&gt;, &lt;Unanswered: UDP:0 TCP:0 ICMP:0 Other:0&gt;)
</pre>

The last line is in fact a the result of the function :
a traceroute result object and a packet list of unanswered packets.
The traceroute result is a more specialised
version (a subclass, in fact) of a classic result object. We can save
it to consult the traceroute result again a bit later, or to deeply inspect 
one of the answers, for example to check padding.


<pre>
<span class=prompt>&gt;&gt;&gt;</span> result,unans=_
<span class=prompt>&gt;&gt;&gt;</span> result.show()
   193.45.10.88:80    216.109.118.79:80  64.241.242.243:80  66.94.229.254:80   
1  192.168.8.1        192.168.8.1        192.168.8.1        192.168.8.1        
2  82.251.4.254       82.251.4.254       82.251.4.254       82.251.4.254     
3  213.228.4.254      213.228.4.254      213.228.4.254      213.228.4.254      
[...]
<span class=prompt>&gt;&gt;&gt;</span> result.filter(lambda x: Padding in x[1])
<filtered Traceroute: UDP:0 TCP:24 ICMP:8 Other:0>
</pre>

Like any result object, traceroute objects can be added :

<pre>
<span class=prompt>&gt;&gt;&gt;</span> r2,unans=traceroute(["www.voila.com"],maxttl=20)
Received 19 packets, got 19 answers, remaining 1 packets
   195.101.94.25:80   
1  192.168.8.1        
2  82.251.4.254     
3  213.228.4.254      
4  212.27.50.169      
5  212.27.50.162      
6  193.252.161.97     
7  193.252.103.86     
8  193.252.103.77     
9  193.252.101.1      
10 193.252.227.245    
12 195.101.94.25   SA 
13 195.101.94.25   SA 
14 195.101.94.25   SA 
15 195.101.94.25   SA 
16 195.101.94.25   SA 
17 195.101.94.25   SA 
18 195.101.94.25   SA 
19 195.101.94.25   SA 
20 195.101.94.25   SA 
&gt;&gt;&gt;
<span class=prompt>&gt;&gt;&gt;</span> r3=result+r2
<span class=prompt>&gt;&gt;&gt;</span> r3.show()
   195.101.94.25:80   212.23.37.13:80    216.109.118.72:80  64.241.242.243:80  66.94.229.254:80   
1  192.168.8.1        192.168.8.1        192.168.8.1        192.168.8.1        192.168.8.1        
2  82.251.4.254       82.251.4.254       82.251.4.254       82.251.4.254       82.251.4.254     
3  213.228.4.254      213.228.4.254      213.228.4.254      213.228.4.254      213.228.4.254      
4  212.27.50.169      212.27.50.169      212.27.50.46       -                  212.27.50.46       
5  212.27.50.162      212.27.50.162      212.27.50.37       212.27.50.41       212.27.50.37       
6  193.252.161.97     194.68.129.168     212.27.50.34       213.228.3.234      193.251.251.69     
7  193.252.103.86     212.23.42.33       217.118.239.185    208.184.231.214    193.251.241.178    
8  193.252.103.77     212.23.42.6        217.118.224.44     64.125.31.129      193.251.242.98     
9  193.252.101.1      212.23.37.13    SA 213.206.129.85     64.125.31.186      193.251.243.89     
10 193.252.227.245    212.23.37.13    SA 213.206.128.160    64.125.29.122      193.251.254.126    
11 -                  212.23.37.13    SA 206.24.169.41      64.125.28.70       216.115.97.178     
12 195.101.94.25   SA 212.23.37.13    SA 206.24.226.100     64.125.28.209      216.115.101.46     
13 195.101.94.25   SA 212.23.37.13    SA 206.24.238.166     64.125.29.45       66.218.82.234      
14 195.101.94.25   SA 212.23.37.13    SA 216.109.74.30      64.125.31.214      66.94.229.254   SA 
15 195.101.94.25   SA 212.23.37.13    SA 216.109.120.151    64.124.229.109     66.94.229.254   SA 
16 195.101.94.25   SA 212.23.37.13    SA 216.109.118.72  SA 64.241.242.243  SA 66.94.229.254   SA 
17 195.101.94.25   SA 212.23.37.13    SA 216.109.118.72  SA 64.241.242.243  SA 66.94.229.254   SA 
18 195.101.94.25   SA 212.23.37.13    SA 216.109.118.72  SA 64.241.242.243  SA 66.94.229.254   SA 
19 195.101.94.25   SA 212.23.37.13    SA 216.109.118.72  SA 64.241.242.243  SA 66.94.229.254   SA 
20 195.101.94.25   SA 212.23.37.13    SA 216.109.118.72  SA 64.241.242.243  SA 66.94.229.254   SA 
</pre>


Traceroute result object also have a very neat feature : they can make a directed graph
from all the routes they got, and cluster them by AS. You will need 
<a href="http://www.research.att.com/sw/tools/graphviz/">graphviz</a>.
By default, <a href="http://www.imagemagick.org/">ImageMagick</a> is used to display
the graph. 

<pre>
<span class=prompt>&gt;&gt;&gt;</span> res,unans = traceroute(["www.microsoft.com","www.cisco.com","www.yahoo.com","www.wanadoo.fr","www.pacsec.com"],dport=[80,443],maxttl=20,retry=-2)
Received 190 packets, got 190 answers, remaining 10 packets
   193.252.122.103:443 193.252.122.103:80 198.133.219.25:443 198.133.219.25:80  207.46...
1  192.168.8.1         192.168.8.1        192.168.8.1        192.168.8.1        192.16...
2  82.251.4.254        82.251.4.254       82.251.4.254       82.251.4.254       82.251...
3  213.228.4.254       213.228.4.254      213.228.4.254      213.228.4.254      213.22...
[...]
<span class=prompt>&gt;&gt;&gt;</span> res.graph()                          # piped to ImageMagick's display program. Image below.
<span class=prompt>&gt;&gt;&gt;</span> res.graph(type="ps",target="| lp")   # piped to postscript printer
<span class=prompt>&gt;&gt;&gt;</span> res.graph(target="> /tmp/graph.svg") # saved to file 
</pre>

<center> 
 <img alt="Traceroute graph" src="img/graph_traceroute.gif">
 <a href=img/graph_traceroute.svg>The same in SVG</a>
</center>

<p>
You also can have a 3D representation of the traceroute. With the right button,
you can rotate the scene, with the middle button, you can zoom, with the
left button, you can move the scene. If you click on a ball, it's IP will
appear/disappear. If you Ctrl-click on a ball, ports 21, 22, 23, 25, 80 and 443
will be scanned and the result displayed.

<pre>
<span class=prompt>&gt;&gt;&gt;</span> res.trace3D()
</pre>

<center>
<img alt="3D trace of a traceroute" src="img/trace3d_1.png"><br>
<img alt="3D trace of a traceroute" src="img/trace3d_2.png"><br>
</center>


<p>
Provided that your wireless card and driver are correctly
configured for frame injection
<pre>
$ ifconfig wlan0 up
$ iwpriv wlan0 hostapd 1
$ ifconfig wlan0ap up
</pre>

you can have a kind of FakeAP.

<pre>
<span class=prompt>&gt;&gt;&gt;</span> sendp(Dot11(addr1="ff:ff:ff:ff:ff:ff",addr2=RandMAC(),addr3=RandMAC())/
          Dot11Beacon(cap="ESS")/
          Dot11Elt(ID="SSID",info=RandString(RandNum(1,50)))/
          Dot11Elt(ID="Rates",info='\x82\x84\x0b\x16')/
          Dot11Elt(ID="DSset",info="\x03")/
          Dot11Elt(ID="TIM",info="\x00\x01\x00\x00"),iface="wlan0ap",loop=1) 
</pre>




</body>
</html>

